<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Snake</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Theme and Variables */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --accent: #F59E0B;
            --background: #0F172A;
            --surface: #1E293B;
            --text: #F8FAFC;
            --text-secondary: #94A3B8;
            --error: #EF4444;
            --success: #22C55E;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        .page-container {
            width: 90%;
            max-width: 800px;
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.1);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Typography */
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 2rem;
            animation: float 6s ease-in-out infinite;
        }

        /* Game Elements */
        #gameCanvas {
            background: radial-gradient(circle at center, var(--surface), var(--background));
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.2);
            transition: var(--transition);
        }

        #gameCanvas:hover {
            box-shadow: 0 0 30px rgba(79, 70, 229, 0.3);
        }

        .game-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .score-panel, .level-panel {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #score, #level {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            position: relative;
        }

        #score::after, #level::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--border-radius);
            border: 2px solid transparent;
            background: linear-gradient(45deg, var(--primary), var(--accent)) border-box;
            mask: 
                linear-gradient(#fff 0 0) padding-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask: 
                linear-gradient(#fff 0 0) padding-box, 
                linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
        }

        /* Buttons */
        button {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: var(--text);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: 0.5s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
        }

        button:hover::before {
            left: 100%;
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .button-group button {
            min-width: 150px;
        }

        /* Modal for Game Over */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1F2937;
            padding: 30px;
            border: 3px solid var(--border-color);
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 20px var(--game-over-color);
        }

        .modal-content h2 {
            color: var(--game-over-color);
            text-shadow: 0 0 10px var(--game-over-color);
        }

        /* High Score Table */
        #highScoresContainer {
            margin-top: 20px;
            background: #1F2937;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }

        #highScoresContainer h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        #highScoresTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #highScoresTable th, #highScoresTable td {
            padding: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #highScoresTable th {
            background-color: #3B82F6;
            color: white;
        }

        #highScoresTable tr:nth-child(even) {
            background-color: #2D3748;
        }

        /* Hide pages by default */
        .page {
            display: none;
        }
        .page.active {
            display: flex;
        }
        
        /* Main Menu Styling */
        #main-menu .button-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --border-radius: 8px;
            }

            h1 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .page-container {
                padding: 1rem;
                width: 95%;
            }

            .game-info {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
            }

            .score-panel, .level-panel {
                font-size: 1rem;
                flex: 1;
                min-width: 120px;
            }

            .controls-panel {
                width: 100%;
                margin-top: 0.5rem;
            }

            button {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }

            .subscription-options {
                flex-direction: column;
                align-items: center;
            }

            .subscription-card {
                width: 100%;
                max-width: 280px;
            }

            .skins-section {
                margin-top: 2rem;
            }

            #skinsContainer {
                gap: 0.5rem;
            }

            .skin-btn {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .buy-stars-section {
                margin-top: 2rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .score-panel, .level-panel {
                font-size: 0.9rem;
            }

            .touch-controls {
                max-width: 240px;
            }

            .touch-btn {
                font-size: 1.2rem;
            }
        }

        @media (max-height: 600px) {
            .page-container {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            h1 {
                margin-bottom: 0.5rem;
            }

            .game-info {
                margin-top: 0.5rem;
            }
        }

        /* Landscape Mode */
        @media (max-height: 480px) and (orientation: landscape) {
            .page-container {
                flex-direction: row;
                align-items: flex-start;
                gap: 1rem;
            }

            .game-wrapper {
                flex: 0 0 auto;
                max-height: 90vh;
            }

            .game-info {
                flex-direction: column;
                height: 100%;
            }

            .touch-controls {
                position: absolute;
                right: 1rem;
                top: 50%;
                transform: translateY(-50%);
                max-width: 160px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading">
        <div class="loading-content">
            <h2 class="loading-title">Galactic Snake</h2>
            <div class="loading-spinner"></div>
        </div>
    </div>


    <div id="main-menu" class="page active">
        <div class="page-container">
            <h1>Galactic Snake</h1>
            <div class="button-group">
                <button id="playGameButton">Play Game</button>
                <button id="viewHighScoresButton">High Scores</button>
                <button id="openStoreButton">Subscription Store</button>
            </div>
        </div>
    </div>

    <!-- Subscription Store Page -->
    <div id="store-page" class="page">
        <div class="page-container">
            <h1>Subscription Store</h1>
            <div class="subscription-options">
                <div class="subscription-card" id="premiumCard">
                    <h2>Premium</h2>
                    <p>Unlock all premium features!</p>
                    <p><strong>$4.99/month</strong></p>
                    <div class="payment-buttons">
                        <button class="payment-btn cashapp-btn" data-plan="premium" data-method="cashapp" data-price="4.99">
                            <img src="https://cash.app/favicon.ico" alt="CashApp" class="payment-icon">
                            Pay with CashApp
                        </button>
                        <button class="payment-btn paypal-btn" data-plan="premium" data-method="paypal" data-price="4.99">
                            <img src="https://www.paypal.com/favicon.ico" alt="PayPal" class="payment-icon">
                            Pay with PayPal
                        </button>
                    </div>
                </div>
                <div class="subscription-card" id="ultimateCard">
                    <h2>Ultimate</h2>
                    <p>All premium + exclusive skins!</p>
                    <p><strong>$9.99/month</strong></p>
                    <div class="payment-buttons">
                        <button class="payment-btn cashapp-btn" data-plan="ultimate" data-method="cashapp" data-price="9.99">
                            <img src="https://cash.app/favicon.ico" alt="CashApp" class="payment-icon">
                            Pay with CashApp
                        </button>
                        <button class="payment-btn paypal-btn" data-plan="ultimate" data-method="paypal" data-price="9.99">
                            <img src="https://www.paypal.com/favicon.ico" alt="PayPal" class="payment-icon">
                            Pay with PayPal
                        </button>
                    </div>
                </div>
            </div>
            <div class="skins-section" style="margin-top:40px;">
                <h2>Choose Your Snake Skin</h2>
                <div style="margin-bottom:10px;font-size:1.1em;color:gold;">
                    <span id="currencyDisplay">Stars: 0</span>
                </div>
                <div id="skinsContainer" style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                    <button class="skin-btn" data-skin="üêç">Classic (Free)</button>
                    <button class="skin-btn" data-skin="ü¶é" data-price="5">Lizard (5‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶î" data-price="10">Hedgehog (10‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶ö" data-price="15">Peacock (15‚≠ê)</button>
                    <button class="skin-btn" data-skin="üêâ" data-price="20">Dragon (20‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶ï" data-price="25">Dino (25‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶ñ" data-price="30">T-Rex (30‚≠ê)</button>
                    <button class="skin-btn" data-skin="üßë‚ÄçüöÄ" data-price="40">Astronaut (40‚≠ê)</button>
                </div>
            <div class="buy-stars-section" style="margin-top:30px;">
                <h2>Buy More Stars</h2>
                <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                    <div style="background:#232946;border:2px solid gold;border-radius:12px;padding:15px;min-width:160px;display:flex;flex-direction:column;align-items:center;">
                        <span style="font-size:1.3em;color:gold;">50‚≠ê</span>
                        <span style="margin:8px 0;">$1.99</span>
                        <button class="buy-stars-btn" data-amount="50" data-price="1.99" data-method="cashapp">Buy with CashApp</button>
                        <button class="buy-stars-btn" data-amount="50" data-price="1.99" data-method="paypal">Buy with PayPal</button>
                    </div>
                    <div style="background:#232946;border:2px solid gold;border-radius:12px;padding:15px;min-width:160px;display:flex;flex-direction:column;align-items:center;">
                        <span style="font-size:1.3em;color:gold;">150‚≠ê</span>
                        <span style="margin:8px 0;">$4.99</span>
                        <button class="buy-stars-btn" data-amount="150" data-price="4.99" data-method="cashapp">Buy with CashApp</button>
                        <button class="buy-stars-btn" data-amount="150" data-price="4.99" data-method="paypal">Buy with PayPal</button>
                    </div>
                    <div style="background:#232946;border:2px solid gold;border-radius:12px;padding:15px;min-width:160px;display:flex;flex-direction:column;align-items:center;">
                        <span style="font-size:1.3em;color:gold;">500‚≠ê</span>
                        <span style="margin:8px 0;">$14.99</span>
                        <button class="buy-stars-btn" data-amount="500" data-price="14.99" data-method="cashapp">Buy with CashApp</button>
                        <button class="buy-stars-btn" data-amount="500" data-price="14.99" data-method="paypal">Buy with PayPal</button>
                    </div>
                </div>
                <p id="buyStarsStatus" style="margin-top:10px;color:var(--accent-color);"></p>
            </div>

            <!-- Buy/Subscription Confirmation Modal -->
            <div id="confirmOrderModal" class="modal">
                <div class="modal-content" style="box-shadow: 0 0 20px gold;">
                    <h2 style="color:gold;">Confirm Your Purchase</h2>
                    <p id="confirmOrderText"></p>
                    <div id="cashappInstructions" style="display:none;color:#FFD700;margin-bottom:10px;">
                        <strong>CashApp:</strong> Please complete your payment and enter your details below to confirm your order.
                    </div>
                    <div style="margin:10px 0;">
                        <div style="margin-bottom:10px;">
                            <label for="phoneInput">Phone Number:</label>
                            <input type="tel" id="phoneInput" placeholder="(123) 456-7890" style="margin-left:8px;">
                        </div>
                        <div>
                            <label for="orderCodeInput">Confirmation Code:</label>
                            <input type="text" id="orderCodeInput" maxlength="12" style="margin-left:8px;" placeholder="Enter code from receipt">
                        </div>
                    </div>
                    <button id="confirmOrderButton">Confirm Order</button>
                    <button id="cancelOrderButton">Cancel</button>
                    <p id="orderCodeStatus" style="margin-top:10px;color:var(--accent-color);"></p>
                </div>
            </div>
            </div>
                <p id="skinStatus" style="margin-top:10px;color:var(--accent-color);"></p>
            </div>
            <div class="button-group">
                <button id="backToMenuFromStore">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="processingModal" class="modal payment-modal">
        <div class="modal-content">
            <div class="payment-modal-content">
                <div class="payment-status">
                    <div class="payment-spinner">
                        <svg class="payment-spinner-svg" viewBox="0 0 48 48">
                            <circle class="spinner-track" cx="24" cy="24" r="20"/>
                            <circle class="spinner-line" cx="24" cy="24" r="20"/>
                        </svg>
                    </div>
                    <h2 class="payment-status-title">Processing Payment</h2>
                    <p class="payment-status-message">Please wait while we process your transaction...</p>
                </div>
                <div class="payment-result success">
                    <div class="payment-icon">‚úì</div>
                    <h2>Payment Successful!</h2>
                    <p>Your purchase has been completed.</p>
                </div>
                <div class="payment-result error">
                    <div class="payment-icon">‚úï</div>
                    <h2>Payment Failed</h2>
                    <p class="error-message">An error occurred during processing.</p>
                    <button class="retry-button">Try Again</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-page" class="page">
        <div class="page-container">
            <h1>Galactic Snake</h1>
            <div class="game-wrapper">
                <canvas id="gameCanvas"></canvas>
                <div id="pauseOverlay" class="pause-overlay">
                    <div class="pause-content">
                        <h2>Paused</h2>
                        <p>Press P or ESC to resume</p>
                    </div>
                </div>
            </div>
            <div class="game-info">
                <div class="score-panel">
                    <p>Score: <span id="score">0</span></p>
                </div>
                <div class="level-panel">
                    <p>Level: <span id="level">1</span></p>
                </div>
                <div class="controls-panel">
                    <button id="backToMenuButton">Back to Menu</button>
                </div>
            </div>
            <div class="touch-controls">
                <div></div>
                <div class="touch-btn" data-direction="up">‚¨ÜÔ∏è</div>
                <div></div>
                <div class="touch-btn" data-direction="left">‚¨ÖÔ∏è</div>
                <div class="touch-btn" data-direction="down">‚¨áÔ∏è</div>
                <div class="touch-btn" data-direction="right">‚û°Ô∏è</div>
            </div>
        </div>
    </div>

    <div id="high-scores-page" class="page">
        <div class="page-container">
            <h1>High Scores</h1>
            <div id="highScoresContainer">
                <h3>Leaderboard</h3>
                <table id="highScoresTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- High scores will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="button-group">
                <button id="backToMenuFromHighScores">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2>Game Over</h2>
            <p id="finalScore"></p>
            <p>Enter your name for the leaderboard:</p>
            <input type="text" id="playerName" maxlength="10" placeholder="Your Name">
            <button id="submitScoreButton">Submit Score</button>
            <button id="restartButton">Restart</button>
        </div>
    </div>

    <style>
        .subscription-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        .subscription-card {
            background: #232946;
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 20px;
            width: 220px;
            box-shadow: 0 0 10px var(--accent-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .subscription-card h2 {
            color: var(--primary-color);
        }
        .payment-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }

        .payment-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .payment-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .cashapp-btn {
            background-color: #00D632;
            color: white;
        }

        .cashapp-btn:hover {
            background-color: #00bf2c;
        }

        .paypal-btn {
            background-color: #0070BA;
            color: white;
        }

        .paypal-btn:hover {
            background-color: #005ea6;
        }
        
        /* Subscription Activation Animation */
        @keyframes activationGlow {
            0% { box-shadow: 0 0 10px gold; }
            50% { box-shadow: 0 0 30px gold, 0 0 50px gold; }
            100% { box-shadow: 0 0 10px gold; }
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFade 1s ease-out forwards;
        }

        @keyframes particleFade {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* Loading Animation */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-content {
            text-align: center;
        }

        .loading-title {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            position: relative;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            animation: pulse-ring 2s ease-out infinite;
        }

        .loading-spinner::before {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            animation: spin 1s linear infinite;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }

        .loading-spinner::after {
            width: 80%;
            height: 80%;
            background: var(--background);
            top: 10%;
            left: 10%;
            animation: spin 1s linear infinite reverse;
            clip-path: polygon(50% 10%, 90% 50%, 50% 90%, 10% 50%);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
        }

        /* Food Collection Effect */
        .food-particle {
            position: fixed;
            pointer-events: none;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            z-index: 100;
        }

        @keyframes particle-explosion {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }

        /* Star Collection Effect */
        .star-particle {
            position: fixed;
            pointer-events: none;
            font-size: 20px;
            z-index: 100;
            animation: float-up 1s ease-out forwards;
        }

        @keyframes float-up {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(0);
                opacity: 0;
            }
        }

        /* Direction Change Effect */
        @keyframes direction-indicator {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: 
                    translate(
                        calc(cos(var(--angle)) * var(--distance)),
                        calc(sin(var(--angle)) * var(--distance))
                    )
                    scale(0);
                opacity: 0;
            }
        }

        .direction-particle {
            pointer-events: none;
            filter: blur(2px);
            box-shadow: 0 0 8px var(--primary);
        }

        /* Celebration Effects */
        .celebration-particle {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            filter: blur(2px);
            animation: explode 1s ease-out forwards;
        }

        .celebration-star {
            position: fixed;
            font-size: 24px;
            pointer-events: none;
            z-index: 1000;
            animation: float-celebrate 1.5s ease-out forwards;
            text-shadow: 0 0 10px currentColor;
        }

        @keyframes explode {
            0% {
                transform: scale(0) translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(1) translate(var(--x), var(--y));
                opacity: 0;
            }
        }

        @keyframes float-celebrate {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translateY(-20px) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0);
                opacity: 0;
            }
        }

        /* Game Container and Responsive Layout */
        .game-wrapper {
            position: relative;
            margin: 0 auto;
            width: 100%;
            max-width: min(80vh, 600px);
            aspect-ratio: 1;
        }

        @media (max-width: 768px) {
            .game-wrapper {
                max-width: 90vw;
            }

            #gameCanvas {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }
        }

        /* Touch Controls */
        .touch-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (hover: none) and (pointer: coarse) {
            .touch-controls {
                display: grid;
            }
        }

        .touch-btn {
            aspect-ratio: 1;
            border: 2px solid var(--primary);
            background: var(--surface);
            color: var(--text);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .touch-btn:active {
            background: var(--primary);
            transform: scale(0.95);
        }

        .touch-btn.pressed {
            background: var(--primary);
            transform: scale(0.95);
        }

        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            border-radius: var(--border-radius);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pause-overlay.active {
            display: flex;
            opacity: 1;
        }

        .pause-content {
            text-align: center;
            color: var(--text);
        }

        .pause-content h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
        }

        .pause-content p {
            font-size: 1rem;
            color: var(--text-secondary);
        }
    </style>
    <script>
    // --- DOM Elements ---
    // Store and navigation elements
    const openStoreButton = document.getElementById('openStoreButton');
    const storePage = document.getElementById('store-page');
    const backToMenuFromStore = document.getElementById('backToMenuFromStore');
    const backToGameFromStore = document.getElementById('backToGameFromStore');
    const processingModal = document.getElementById('processingModal');
    
    // Skins and currency elements
    const skinsContainer = document.getElementById('skinsContainer');
    const skinStatus = document.getElementById('skinStatus');
    const currencyDisplay = document.getElementById('currencyDisplay');
    
    // Payment and modal elements
    const confirmOrderModal = document.getElementById('confirmOrderModal');
    const confirmOrderText = document.getElementById('confirmOrderText');
    const orderCodeInput = document.getElementById('orderCodeInput');
    const phoneInput = document.getElementById('phoneInput');
    const confirmOrderButton = document.getElementById('confirmOrderButton');
    const cancelOrderButton = document.getElementById('cancelOrderButton');
    const orderCodeStatus = document.getElementById('orderCodeStatus');
    const cashappInstructions = document.getElementById('cashappInstructions');
    const buyStarsStatus = document.getElementById('buyStarsStatus');
        // --- Processing Modal Functions ---
        function showProcessing() {
            processingModal.style.display = 'flex';
        }
        function hideProcessing() {
            processingModal.style.display = 'none';
        }
        const mainMenu = document.getElementById('main-menu');
        const gamePage = document.getElementById('game-page');
        const highScoresPage = document.getElementById('high-scores-page');
        const playGameButton = document.getElementById('playGameButton');
        const viewHighScoresButton = document.getElementById('viewHighScoresButton');
        const backToMenuButton = document.getElementById('backToMenuButton');
        const backToMenuFromHighScores = document.getElementById('backToMenuFromHighScores');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const restartButton = document.getElementById('restartButton');
        const submitScoreButton = document.getElementById('submitScoreButton');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreElement = document.getElementById('finalScore');
        const playerNameInput = document.getElementById('playerName');
        const highScoresTableBody = document.querySelector('#highScoresTable tbody');

        // --- Game Constants and State ---
        const gridSize = 20;
        const canvasSize = 400;
        canvas.width = canvasSize;
        canvas.height = canvasSize;

        const GAME_CONFIG = {
            initialSpeed: 200, // ms between moves
            speedIncrease: 10,
            minSpeed: 50,
            snakeMovementSmoothing: 0.15, // Lower = smoother but slower
            gridSize: 20,
            canvasSize: 400
        };

        let gameState = {
            snake: [],
            food: null,
            score: 0,
            level: 1,
            direction: { x: 1, y: 0 },
            nextDirection: { x: 1, y: 0 },
            lastUpdate: 0,
            speed: GAME_CONFIG.initialSpeed,
            isPaused: false,
            isGameOver: false,
            snakePositions: [], // For interpolation
            frameId: null
        };

        const spaceEmojis = ['ü™ê', '‚ú®', 'üõ∏', 'üöÄ', 'üåå', 'üå†'];
        // --- Skins ---
        const SKIN_KEY = 'galacticSnakeSkin';
        // --- Skins and Currency ---
        const skinAccess = {
            'üêç': true, // Classic
            'ü¶é': false, // Lizard
            'ü¶î': false, // Hedgehog
            'ü¶ö': false, // Peacock
            'üêâ': false, // Dragon
            'ü¶ï': false, // Dino
            'ü¶ñ': false, // T-Rex
            'üßë‚ÄçüöÄ': false // Astronaut
        };
    const SUBSCRIPTION_STATUS_KEY = 'galacticSnakeSubscription';
    let subscriptionStatus = localStorage.getItem(SUBSCRIPTION_STATUS_KEY) || 'none'; // 'none', 'premium', or 'ultimate'
        const skinTailColors = {
            'üêç': '#4CAF50',
            'ü¶é': '#8BC34A',
            'ü¶î': '#795548',
            'ü¶ö': '#2196F3',
            'üêâ': '#E91E63',
            'ü¶ï': '#FFEB3B',
            'ü¶ñ': '#FF9800',
            'üßë‚ÄçüöÄ': '#B0BEC5'
        };
        const CURRENCY_KEY = 'galacticSnakeStars';
        let stars = parseInt(localStorage.getItem(CURRENCY_KEY) || '50'); // Start with 50 for demo
        let snakeHeadEmoji = localStorage.getItem(SKIN_KEY) || 'üêç';
        const initialGameSpeed = 150;
        const speedIncreasePerLevel = 10;
        const HIGH_SCORES_KEY = 'galacticSnakeHighScores';

    // --- Page Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function navigateTo(pageId) {
            showPage(pageId);
            // Stop the game if we navigate away from the game page
            if (pageId !== 'game-page') {
                clearInterval(gameInterval);
            }
            if (pageId === 'high-scores-page') {
                displayHighScores();
            }
        }

        // --- High Score Functions ---
        function getHighScores() {
            const highScores = JSON.parse(localStorage.getItem(HIGH_SCORES_KEY) || '[]');
            return highScores.sort((a, b) => b.score - a.score).slice(0, 10);
        }

        function saveHighScores(scoreEntry) {
            const highScores = getHighScores();
            highScores.push(scoreEntry);
            const sortedScores = highScores.sort((a, b) => b.score - a.score).slice(0, 10);
            localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(sortedScores));
        }

        function displayHighScores() {
            const highScores = getHighScores();
            highScoresTableBody.innerHTML = '';

            highScores.forEach((entry, index) => {
                const row = highScoresTableBody.insertRow();
                const rankCell = row.insertCell();
                const nameCell = row.insertCell();
                const scoreCell = row.insertCell();

                rankCell.textContent = index + 1;
                nameCell.textContent = entry.name;
                scoreCell.textContent = entry.score;
            });
        }

        // --- Game Functions ---
        function initGame() {
            gameState = {
                snake: [{ x: 10, y: 10 }],
                food: null,
                score: 0,
                level: 1,
                direction: { x: 1, y: 0 },
                nextDirection: { x: 1, y: 0 },
                lastUpdate: 0,
                speed: GAME_CONFIG.initialSpeed,
                isPaused: false,
                isGameOver: false,
                snakePositions: [{ x: 10, y: 10 }],
                frameId: null
            };

            gameOverModal.style.display = 'none';
            scoreElement.textContent = gameState.score;
            levelElement.textContent = gameState.level;
            playerNameInput.value = '';
            
            generateFood();
            
            if (gameState.frameId) {
                cancelAnimationFrame(gameState.frameId);
            }
            
            // Start the game loop
            gameLoop(performance.now());
        }

        // Handle pause/unpause
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const pauseOverlay = document.getElementById('pauseOverlay');
            
            if (gameState.isPaused) {
                pauseOverlay.classList.add('active');
            } else {
                pauseOverlay.classList.remove('active');
                gameState.lastUpdate = performance.now();
                gameLoop(gameState.lastUpdate);
            }
        }

        function generateFood() {
            let newFoodPosition;
            do {
                newFoodPosition = {
                    x: Math.floor(Math.random() * (canvasSize / gridSize)),
                    y: Math.floor(Math.random() * (canvasSize / gridSize)),
                    emoji: spaceEmojis[Math.floor(Math.random() * spaceEmojis.length)]
                };
            } while (isSnakeCollision(newFoodPosition));
            food = newFoodPosition;
        }

        function isSnakeCollision(position) {
            return snake.some(segment => segment.x === position.x && segment.y === position.y);
        }

        function gameLoop(timestamp) {
            if (gameState.isGameOver || gameState.isPaused) {
                return;
            }

            gameState.frameId = requestAnimationFrame(gameLoop);

            // Update game state at fixed time intervals
            if (timestamp - gameState.lastUpdate >= gameState.speed) {
                // Update direction
                gameState.direction = { ...gameState.nextDirection };

                // Calculate new head position
                const head = {
                    x: gameState.snake[0].x + gameState.direction.x,
                    y: gameState.snake[0].y + gameState.direction.y
                };

                // Check for collisions
                if (isCollision(head)) {
                    endGame();
                    return;
                }

                // Update snake positions array for interpolation
                gameState.snakePositions = gameState.snake.map(segment => ({ ...segment }));

                // Move snake
                gameState.snake.unshift(head);

                // Check for food collision
                if (head.x === gameState.food.x && head.y === gameState.food.y) {
                    handleFoodCollection();
                } else {
                    gameState.snake.pop();
                }

                gameState.lastUpdate = timestamp;
            }

            // Render frame
            draw(timestamp);
        }

        function isCollision(position) {
            // Wall collision
            if (
                position.x < 0 || 
                position.x >= GAME_CONFIG.canvasSize / GAME_CONFIG.gridSize ||
                position.y < 0 || 
                position.y >= GAME_CONFIG.canvasSize / GAME_CONFIG.gridSize
            ) {
                return true;
            }

            // Self collision - check against all segments except the tail (which will move)
            return gameState.snake.slice(0, -1).some(segment => 
                segment.x === position.x && segment.y === position.y
            );
        }

        function handleFoodCollection() {
            // Food collection effect
            const foodRect = canvas.getBoundingClientRect();
            const foodX = foodRect.left + (gameState.food.x * gridSize) + (gridSize / 2);
            const foodY = foodRect.top + (gameState.food.y * gridSize) + (gridSize / 2);
            createFoodParticles(foodX, foodY);

            // Update score
            gameState.score++;
            scoreElement.textContent = gameState.score;
            
            // Award 1 Star
            stars++;
            updateCurrencyDisplay();
            createStarParticle(foodX, foodY, '‚≠ê');
            
            // Level up check
            if (gameState.score % 5 === 0) {
                gameState.level++;
                levelElement.textContent = gameState.level;
                
                // Award 5 Stars for leveling up
                stars += 5;
                updateCurrencyDisplay();
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        createStarParticle(foodX, foodY, '‚≠ê');
                    }, i * 100);
                }
                
                // Increase speed
                gameState.speed = Math.max(
                    GAME_CONFIG.minSpeed,
                    gameState.speed - GAME_CONFIG.speedIncrease
                );
            }
            
            // Bonus stars for milestone scores
            if (gameState.score > 0 && gameState.score % 25 === 0) {
                stars += 10;
                updateCurrencyDisplay();
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        createStarParticle(foodX, foodY, 'üåü');
                    }, i * 100);
                }
            }

            generateFood();
        }
            
            function createFoodParticles(x, y) {
                const particleCount = 12;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'food-particle';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    
                    const angle = (i / particleCount) * Math.PI * 2;
                    const velocity = 2 + Math.random() * 2;
                    const dx = Math.cos(angle) * velocity * 20;
                    const dy = Math.sin(angle) * velocity * 20;
                    
                    particle.style.setProperty('--x', dx + 'px');
                    particle.style.setProperty('--y', dy + 'px');
                    particle.style.animation = 'particle-explosion 0.6s ease-out forwards';
                    
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 600);
                }
            }
            
            function createStarParticle(x, y, emoji) {
                const particle = document.createElement('div');
                particle.className = 'star-particle';
                particle.textContent = emoji;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }

            draw();
        }

        function draw(timestamp) {
            ctx.clearRect(0, 0, GAME_CONFIG.canvasSize, GAME_CONFIG.canvasSize);

            // Calculate interpolation factor
            const timeSinceUpdate = timestamp - gameState.lastUpdate;
            const interpolationFactor = Math.min(
                timeSinceUpdate / gameState.speed, 
                1
            ) * GAME_CONFIG.snakeMovementSmoothing;

            // Draw snake with interpolation
            gameState.snake.forEach((segment, index) => {
                let renderX = segment.x;
                let renderY = segment.y;

                // Interpolate position for smooth movement
                if (index < gameState.snakePositions.length) {
                    const previousPos = gameState.snakePositions[index];
                    renderX = previousPos.x + (segment.x - previousPos.x) * interpolationFactor;
                    renderY = previousPos.y + (segment.y - previousPos.y) * interpolationFactor;
                }

                if (index === 0) {
                    // Draw head with emoji and glow effect
                    ctx.save();
                    ctx.font = `${GAME_CONFIG.gridSize}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Outer glow
                    ctx.shadowColor = 'var(--primary)';
                    ctx.shadowBlur = 15;
                    ctx.fillText(
                        snakeHeadEmoji, 
                        renderX * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2,
                        renderY * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2
                    );
                    
                    // Inner glow
                    ctx.shadowBlur = 5;
                    ctx.fillText(
                        snakeHeadEmoji,
                        renderX * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2,
                        renderY * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2
                    );
                    
                    ctx.restore();
                } else {
                    // Draw body segments with gradient
                    const gradient = ctx.createRadialGradient(
                        renderX * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2,
                        renderY * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2,
                        0,
                        renderX * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2,
                        renderY * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2,
                        GAME_CONFIG.gridSize / 2
                    );

                    const baseColor = skinTailColors[snakeHeadEmoji] || 'var(--primary)';
                    gradient.addColorStop(0, baseColor);
                    gradient.addColorStop(1, adjustColor(baseColor, -20));

                    ctx.fillStyle = gradient;
                    ctx.shadowColor = baseColor;
                    ctx.shadowBlur = 5;
                    ctx.beginPath();
                    ctx.roundRect(
                        renderX * GAME_CONFIG.gridSize,
                        renderY * GAME_CONFIG.gridSize,
                        GAME_CONFIG.gridSize - 1,
                        GAME_CONFIG.gridSize - 1,
                        4
                    );
                    ctx.fill();
                }
            });

            // Draw food with animation and glow effect
            if (gameState.food) {
                ctx.save();
                ctx.font = `${GAME_CONFIG.gridSize}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Pulsing animation
                const pulse = Math.sin(timestamp / 500) * 0.1 + 1;
                ctx.scale(pulse, pulse);
                
                // Glow effect
                ctx.shadowColor = 'var(--accent)';
                ctx.shadowBlur = 15;
                ctx.fillText(
                    gameState.food.emoji,
                    (gameState.food.x * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2) / pulse,
                    (gameState.food.y * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2) / pulse
                );
                
                ctx.restore();
            }
        }

        // Helper function to adjust color brightness
        function adjustColor(color, amount) {
            // Remove 'var(--' and ')' if it's a CSS variable
            if (color.startsWith('var(--')) {
                color = getComputedStyle(document.documentElement)
                    .getPropertyValue(color.slice(5, -1))
                    .trim();
            }
            
            // Convert to RGB
            const rgb = color.startsWith('#') 
                ? hexToRgb(color)
                : parseRgb(color);
                
            if (!rgb) return color;
            
            // Adjust brightness
            const adjusted = Object.values(rgb).map(c => 
                Math.max(0, Math.min(255, c + amount))
            );
            
            return `rgb(${adjusted.join(',')})`;
        }

        // Helper function to convert hex to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // Helper function to parse RGB string
        function parseRgb(rgb) {
            const result = /^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/.exec(rgb);
            return result ? {
                r: parseInt(result[1]),
                g: parseInt(result[2]),
                b: parseInt(result[3])
            } : null;
        }
    // --- Skins Selection Logic ---
    function updateSkinAccess() {
        // Only Classic is always accessible
        skinAccess['üêç'] = true;
        Object.keys(skinAccess).forEach(skin => {
            if (localStorage.getItem('skinPurchased_' + skin) === 'true') {
                skinAccess[skin] = true;
            }
        });
    }
    // --- Buy Stars Logic ---
    // --- Buy Stars Confirmation Logic ---
    let pendingOrder = null;
    // Discord webhook URL (replace with your actual webhook URL)
    const DISCORD_WEBHOOK_URL = 'YOUR_DISCORD_WEBHOOK_URL';

    // Function to validate phone number
    function validatePhoneNumber(phone) {
        const phoneRegex = /^\(\d{3}\) \d{3}-\d{4}$/;
        return phoneRegex.test(phone);
    }

    // Function to format phone number as user types
    function formatPhoneNumber(input) {
        const cleaned = input.replace(/\D/g, '');
        const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
        if (match) {
            return '(' + match[1] + ') ' + match[2] + '-' + match[3];
        }
        return input;
    }

    // Function to send order details to Discord
    async function sendToDiscord(orderDetails) {
        try {
            const response = await fetch(DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: '**New Order Received!**',
                    embeds: [{
                        title: 'Order Details',
                        color: 0x00ff00,
                        fields: [
                            {
                                name: 'Order Type',
                                value: orderDetails.type.charAt(0).toUpperCase() + orderDetails.type.slice(1),
                                inline: true
                            },
                            {
                                name: 'Amount',
                                value: orderDetails.amount ? `${orderDetails.amount} Stars` : 'N/A',
                                inline: true
                            },
                            {
                                name: 'Price',
                                value: `$${orderDetails.price}`,
                                inline: true
                            },
                            {
                                name: 'Payment Method',
                                value: orderDetails.method.charAt(0).toUpperCase() + orderDetails.method.slice(1),
                                inline: true
                            },
                            {
                                name: 'Phone',
                                value: orderDetails.phone,
                                inline: true
                            }
                        ],
                        timestamp: new Date()
                    }]
                })
            });
            return response.ok;
        } catch (error) {
            console.error('Error sending to Discord:', error);
            return false;
        }
    }

    // Obfuscated reusable codes (base64 encoded)
    const REUSABLE_CODES = {
        premium: atob('UFJFTUlVTTExMw=='),
        ultimate: atob('VUxUUkE5OTk='),   
        stars1: atob('U1RBUlMwNTA='),   // 50 stars
        stars2: atob('U1RBUlMxNTA='),  // 150 stars
        stars3: atob('U1RBUlM1MDA=')   // 500 stars
    };

    // Particle animation function
    function createParticleExplosion(x, y, color, count = 30) {
        for (let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.backgroundColor = color;
            particle.style.width = '8px';
            particle.style.height = '8px';
            particle.style.borderRadius = '50%';
            
            // Random direction and distance
            const angle = (Math.random() * Math.PI * 2);
            const distance = 100 + Math.random() * 100;
            particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
            particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
            
            document.body.appendChild(particle);
            
            // Remove particle after animation
            setTimeout(() => particle.remove(), 1000);
        }
    }

    // Update subscription UI based on status
    function updateSubscriptionUI(animate = false) {
        document.querySelectorAll('.subscription-card').forEach(card => {
            const plan = card.querySelector('h2').textContent.toLowerCase();
            if (plan === subscriptionStatus || 
                (subscriptionStatus === 'ultimate' && plan === 'premium')) {
                if (animate) {
                    // Get card position for particle effect
                    const rect = card.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    // Create particle explosion
                    const color = plan === 'ultimate' ? '#9c27b0' : '#4CAF50';
                    createParticleExplosion(centerX, centerY, color);
                    
                    // Add glow animation
                    card.style.animation = 'activationGlow 1.5s ease-in-out';
                }
                
                card.style.border = '2px solid gold';
                card.querySelector('h2').style.color = 'gold';
                card.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = 'Active';
                    btn.style.backgroundColor = '#4CAF50';
                });
            }
        });
    }

    // Call this when subscription changes
    function updateSubscriptionStatus(newStatus) {
        subscriptionStatus = newStatus;
        localStorage.setItem(SUBSCRIPTION_STATUS_KEY, newStatus);
        updateSubscriptionUI(true); // Pass true to trigger animation
    }
    function showConfirmOrderModal(type, amount, method, price) {
        let code = '';
        let text = '';
        if (type === 'stars') {
            code = amount === 50 ? REUSABLE_CODES.stars1 : amount === 150 ? REUSABLE_CODES.stars2 : amount === 500 ? REUSABLE_CODES.stars3 : '';
            text = `Order: ${amount} Stars for $${price} via ${method === 'cashapp' ? 'CashApp' : 'PayPal'}`;
        } else if (type === 'premium') {
            code = REUSABLE_CODES.premium;
            text = `Order: Premium Subscription for $${price}/month via ${method === 'cashapp' ? 'CashApp' : 'PayPal'}`;
        } else if (type === 'ultimate') {
            code = REUSABLE_CODES.ultimate;
            text = `Order: Ultimate Subscription for $${price}/month via ${method === 'cashapp' ? 'CashApp' : 'PayPal'}`;
        }
        pendingOrder = {
            type,
            amount,
            method,
            price,
            code
        };
        confirmOrderText.textContent = text;
        orderCodeInput.value = '';
        orderCodeStatus.textContent = '';
        cashappInstructions.style.display = method === 'cashapp' ? 'block' : 'none';
        confirmOrderModal.style.display = 'flex';
        setTimeout(() => {
            window.open(method === 'cashapp' ? 'https://cash.app/' : 'https://www.paypal.com/', '_blank');
        }, 500);
    }
    function hideConfirmOrderModal() {
        confirmOrderModal.style.display = 'none';
        pendingOrder = null;
    }
    // Phone input auto-formatting is set up in initializePaymentSystem()

    confirmOrderButton.addEventListener('click', async () => {
        if (!pendingOrder) return;

        const processingModal = document.getElementById('processingModal');
        const paymentStatus = processingModal.querySelector('.payment-status');
        const successResult = processingModal.querySelector('.payment-result.success');
        const errorResult = processingModal.querySelector('.payment-result.error');

        const phone = phoneInput.value.trim();
        const entered = orderCodeInput.value.trim().toUpperCase();

        // Show processing modal
        hideConfirmOrderModal();
        processingModal.style.display = 'flex';
        document.querySelectorAll('.payment-result, .payment-status').forEach(el => el.classList.remove('active'));
        paymentStatus.classList.add('active');

        try {
            // Validate phone number
            if (!validatePhoneNumber(phone)) {
                throw new Error('Please enter a valid phone number in (123) 456-7890 format');
            }

            let validCode = false;
            if (pendingOrder.type === 'stars') {
                validCode = (pendingOrder.amount === 50 && entered === REUSABLE_CODES.stars1)
                    || (pendingOrder.amount === 150 && entered === REUSABLE_CODES.stars2)
                    || (pendingOrder.amount === 500 && entered === REUSABLE_CODES.stars3);
                
                if (!validCode) {
                    throw new Error('Invalid confirmation code. Please check your receipt and try again.');
                }

                // Send to Discord webhook
                const success = await sendToDiscord({
                    ...pendingOrder,
                    phone
                });

                if (!success) {
                    throw new Error('Error processing order. Please try again.');
                }

                // Add stars with animation
                const currentStars = stars;
                const targetStars = currentStars + pendingOrder.amount;
                const duration = 1000; // 1 second
                const startTime = Date.now();

                function animateStars() {
                    const currentTime = Date.now();
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    const currentValue = Math.floor(currentStars + (pendingOrder.amount * progress));
                    
                    stars = currentValue;
                    updateCurrencyDisplay();

                    if (progress < 1) {
                        requestAnimationFrame(animateStars);
                    }
                }

                animateStars();
                
                // Show success
                paymentStatus.classList.remove('active');
                successResult.classList.add('active');
                buyStarsStatus.textContent = `Order confirmed! ${pendingOrder.amount} Stars added.`;
                
                // Create celebration effect
                createCelebrationEffect();
                
            } else if (pendingOrder.type === 'premium' || pendingOrder.type === 'ultimate') {
                validCode = entered === pendingOrder.code;
                
                if (!validCode) {
                    throw new Error('Invalid confirmation code. Please check your receipt and try again.');
                }

                // Send to Discord webhook
                const success = await sendToDiscord({
                    ...pendingOrder,
                    phone
                });

                if (!success) {
                    throw new Error('Error processing order. Please try again.');
                }

                updateSubscriptionStatus(pendingOrder.type);
                
                // Show success
                paymentStatus.classList.remove('active');
                successResult.classList.add('active');
                buyStarsStatus.textContent = `Order confirmed! ${pendingOrder.type.charAt(0).toUpperCase() + pendingOrder.type.slice(1)} subscription activated.`;
                
                // Create celebration effect
                createCelebrationEffect();
            }

            // Hide processing modal after delay
            setTimeout(() => {
                processingModal.style.display = 'none';
            }, 2000);

        } catch (error) {
            console.error('Payment error:', error);
            
            // Show error state
            paymentStatus.classList.remove('active');
            errorResult.classList.add('active');
            errorResult.querySelector('.error-message').textContent = error.message;
            
            // Add retry handler
            const retryButton = errorResult.querySelector('.retry-button');
            retryButton.onclick = () => {
                processingModal.style.display = 'none';
                showConfirmOrderModal(pendingOrder.type, pendingOrder.amount, pendingOrder.method, pendingOrder.price);
            };
        }
    });

    function createCelebrationEffect() {
        const container = document.querySelector('.page-container');
        const rect = container.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        // Create burst of particles
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'celebration-particle';
            
            const hue = Math.random() * 360;
            particle.style.background = `hsl(${hue}, 100%, 60%)`;
            
            const angle = (i / 30) * Math.PI * 2;
            const velocity = 2 + Math.random() * 2;
            const distance = 100 + Math.random() * 100;
            
            particle.style.left = centerX + 'px';
            particle.style.top = centerY + 'px';
            
            const dx = Math.cos(angle) * velocity * distance;
            const dy = Math.sin(angle) * velocity * distance;
            
            particle.style.setProperty('--x', dx + 'px');
            particle.style.setProperty('--y', dy + 'px');
            
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
        }
        
        // Create floating stars/coins
        for (let i = 0; i < 10; i++) {
            setTimeout(() => {
                const star = document.createElement('div');
                star.className = 'celebration-star';
                star.textContent = pendingOrder.type === 'stars' ? '‚≠ê' : 'üåü';
                
                star.style.left = (centerX - 20 + Math.random() * 40) + 'px';
                star.style.top = (centerY + 50) + 'px';
                
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 1500);
            }, i * 100);
        }
    }
    cancelOrderButton.addEventListener('click', () => {
        hideConfirmOrderModal();
        buyStarsStatus.textContent = 'Order cancelled.';
    });

    function updateCurrencyDisplay() {
        if (currencyDisplay) currencyDisplay.textContent = `Stars: ${stars}`;
        localStorage.setItem(CURRENCY_KEY, stars);
    }

    function selectSkin(skin) {
        updateSkinAccess();
        if (skinAccess[skin]) {
            snakeHeadEmoji = skin;
            localStorage.setItem(SKIN_KEY, skin);
            skinStatus.textContent = `Skin changed to ${skin}!`;
        } else {
            // Try to buy if price exists
            const btn = skinsContainer.querySelector(`[data-skin='${skin}']`);
            const price = parseInt(btn.getAttribute('data-price') || '0');
            if (price > 0) {
                if (stars >= price) {
                    stars -= price;
                    skinAccess[skin] = true;
                    localStorage.setItem('skinPurchased_' + skin, 'true');
                    updateCurrencyDisplay();
                    snakeHeadEmoji = skin;
                    localStorage.setItem(SKIN_KEY, skin);
                    skinStatus.textContent = `Purchased and equipped ${skin}!`;
                } else {
                    skinStatus.textContent = `Not enough Stars to buy this skin!`;
                }
            } else {
                skinStatus.textContent = `This skin is locked!`;
            }
        }
    }

    if (skinsContainer) {
        updateSkinAccess();
        updateCurrencyDisplay();
        skinsContainer.querySelectorAll('.skin-btn').forEach(btn => {
            const skin = btn.getAttribute('data-skin');
            // Show owned/unowned status
            if (skinAccess[skin]) {
                btn.textContent += ' (Owned)';
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
            btn.addEventListener('click', function() {
                selectSkin(skin);
                // Update button labels after purchase
                updateSkinAccess();
                skinsContainer.querySelectorAll('.skin-btn').forEach(b => {
                    const s = b.getAttribute('data-skin');
                    if (skinAccess[s]) {
                        b.textContent = b.textContent.replace(/ ?\(Owned\)?$/, '') + ' (Owned)';
                    } else {
                        b.textContent = b.textContent.replace(/ ?\(Owned\)?$/, '');
                    }
                });
            });
        });
    }

    // Buy Stars event listeners
    document.querySelectorAll('.buy-stars-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const amount = parseInt(btn.getAttribute('data-amount'));
            const price = btn.getAttribute('data-price');
            const method = btn.getAttribute('data-method');
            showConfirmOrderModal('stars', amount, method, price);
        });
    });

        function endGame() {
            clearInterval(gameInterval);
            finalScoreElement.textContent = `Your final score is: ${score}`;
            gameOverModal.style.display = 'flex';
        }

        function handleSubmitScore() {
            const playerName = playerNameInput.value.trim();
            if (playerName) {
                saveHighScores({ name: playerName, score: score });
            }
            gameOverModal.style.display = 'none';
            navigateTo('main-menu');
        }

        function handleKeyPress(e) {
            if (gameState.isGameOver) return;

            const key = e.key;
            
            // Handle pause
            if (key === 'p' || key === 'Escape') {
                togglePause();
                return;
            }

            // Don't process movement keys if paused
            if (gameState.isPaused) return;

            const currentDir = gameState.direction;
            let newDirection = null;

            switch (key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (currentDir.y === 0) {
                        newDirection = { x: 0, y: -1 };
                    }
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (currentDir.y === 0) {
                        newDirection = { x: 0, y: 1 };
                    }
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (currentDir.x === 0) {
                        newDirection = { x: -1, y: 0 };
                    }
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (currentDir.x === 0) {
                        newDirection = { x: 1, y: 0 };
                    }
                    break;
            }

            if (newDirection) {
                e.preventDefault(); // Prevent page scrolling
                
                // Store the next direction - will be applied on next game update
                gameState.nextDirection = newDirection;
                
                // Add visual feedback for direction change
                const head = gameState.snake[0];
                const particleX = head.x * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2;
                const particleY = head.y * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2;
                createDirectionChangeEffect(particleX, particleY, newDirection);
            }
        }

        function createDirectionChangeEffect(x, y, direction) {
            const particle = document.createElement('div');
            particle.className = 'direction-particle';
            particle.style.position = 'absolute';
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.width = '8px';
            particle.style.height = '8px';
            particle.style.background = 'var(--primary)';
            particle.style.borderRadius = '50%';
            particle.style.zIndex = '100';
            
            // Calculate angle based on direction
            const angle = Math.atan2(direction.y, direction.x);
            const distance = 20;
            
            // Set animation properties
            particle.style.animation = 'direction-indicator 0.3s ease-out forwards';
            particle.style.setProperty('--angle', angle + 'rad');
            particle.style.setProperty('--distance', distance + 'px');
            
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 300);
        }
        
        // --- Event Listeners ---
        document.addEventListener('keydown', handleKeyPress);
        playGameButton.addEventListener('click', () => {
            initGame();
            navigateTo('game-page');
        });
        viewHighScoresButton.addEventListener('click', () => {
            navigateTo('high-scores-page');
        });
        backToMenuButton.addEventListener('click', () => {
            navigateTo('main-menu');
        });
        backToMenuFromHighScores.addEventListener('click', () => {
            navigateTo('main-menu');
        });
        restartButton.addEventListener('click', initGame);
        submitScoreButton.addEventListener('click', handleSubmitScore);
        openStoreButton.addEventListener('click', () => {
            navigateTo('store-page');
            updateSubscriptionUI();  // Update subscription buttons when store page opens
        });
        backToMenuFromStore.addEventListener('click', () => {
            navigateTo('main-menu');
        });
        backToGameFromStore.addEventListener('click', () => {
            navigateTo('game-page');
        });

        // Payment flow with unified button handling
        document.querySelectorAll('.payment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const plan = this.dataset.plan;
                const method = this.dataset.method;
                const price = this.dataset.price;
                
                // Add click animation
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 100);

                showProcessing();
                
                // Delay to show processing animation
                setTimeout(() => {
                    hideProcessing();
                    showConfirmOrderModal(plan, null, method, price);
                }, 500);
            });

            // Add hover glow effect
            button.addEventListener('mouseenter', function() {
                this.style.boxShadow = `0 0 20px ${this.classList.contains('cashapp-btn') ? '#00D632' : '#0070BA'}`;
            });

            button.addEventListener('mouseleave', function() {
                this.style.boxShadow = '';
            });
        });

        // Initialize payment system
        function initializePaymentSystem() {
            // Set up button event listeners
            document.querySelectorAll('.payment-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const plan = this.dataset.plan;
                    const method = this.dataset.method;
                    const price = this.dataset.price;
                    
                    console.log('Payment button clicked:', { plan, method, price }); // Debug log
                    
                    // Visual feedback
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => this.style.transform = '', 200);

                    // Show processing
                    showProcessing();
                    
                    // Show order modal after brief delay
                    setTimeout(() => {
                        hideProcessing();
                        showConfirmOrderModal(plan, null, method, price);
                    }, 800);
                });

                // Add hover effect
                button.addEventListener('mouseenter', function() {
                    this.style.boxShadow = `0 0 20px ${this.classList.contains('cashapp-btn') ? '#00D632' : '#0070BA'}`;
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.boxShadow = '';
                });
            });
            
            // Set up confirmation modal
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    const formatted = formatPhoneNumber(e.target.value);
                    e.target.value = formatted;
                });
            }

            // Update UI based on current subscription
            updateSubscriptionUI();
        }

        // Create celebration effect with particles and stars
        function createCelebrationEffect() {
            const colors = ['#FFD700', '#FFA500', '#FF4500', '#9370DB', '#00CED1'];
            const count = 30; // Number of particles

            // Create container for celebration effects if it doesn't exist
            let container = document.getElementById('celebration-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'celebration-container';
                document.body.appendChild(container);
            }

            // Create particles
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'celebration-particle';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // Random position within viewport
                const startX = window.innerWidth / 2;
                const startY = window.innerHeight / 2;
                particle.style.left = `${startX}px`;
                particle.style.top = `${startY}px`;

                // Random direction
                const angle = (Math.random() * Math.PI * 2);
                const distance = 100 + Math.random() * 200;
                particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);

                container.appendChild(particle);
            }

            // Create floating stars
            for (let i = 0; i < 5; i++) {
                const star = document.createElement('div');
                star.className = 'celebration-star';
                star.textContent = '‚≠ê';
                star.style.color = colors[Math.floor(Math.random() * colors.length)];
                
                // Random horizontal position
                const posX = 30 + Math.random() * (window.innerWidth - 60);
                star.style.left = `${posX}px`;
                star.style.top = `${window.innerHeight - 50}px`;

                container.appendChild(star);
            }

            // Clean up after animations complete
            setTimeout(() => {
                if (container) {
                    container.innerHTML = '';
                }
            }, 2000);
        }

        // Initialize game immediately and load other assets in background
        function initializeGameAssets() {
            return new Promise((resolve) => {
                // Start game immediately
                resolve();
                
                // Load payment assets in background only when needed
                const loadPaymentAssets = () => {
                    const images = [
                        'https://cash.app/favicon.ico',
                        'https://www.paypal.com/favicon.ico'
                    ];
                    
                    images.forEach(src => {
                        const img = new Image();
                        img.src = src; // No need to wait for these
                    });
                };

                // Load payment assets when user interacts with payment UI
                document.querySelector('.shop-btn').addEventListener('click', loadPaymentAssets, { once: true });
            });
        }

        // Touch controls handler
        function initializeTouchControls() {
            const touchButtons = document.querySelectorAll('.touch-btn');
            
            touchButtons.forEach(btn => {
                ['touchstart', 'mousedown'].forEach(eventType => {
                    btn.addEventListener(eventType, (e) => {
                        e.preventDefault();
                        const direction = btn.dataset.direction;
                        btn.classList.add('pressed');
                        
                        handleDirectionInput(direction);
                    });
                });
                
                ['touchend', 'mouseup', 'mouseleave'].forEach(eventType => {
                    btn.addEventListener(eventType, () => {
                        btn.classList.remove('pressed');
                    });
                });
            });
            
            // Handle swipe gestures on game canvas
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            
            canvas.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Prevent scrolling while swiping
            });
            
            canvas.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                
                // Minimum swipe distance (in pixels)
                const minSwipeDistance = 30;
                
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    if (Math.abs(deltaX) > minSwipeDistance) {
                        handleDirectionInput(deltaX > 0 ? 'right' : 'left');
                    }
                } else {
                    if (Math.abs(deltaY) > minSwipeDistance) {
                        handleDirectionInput(deltaY > 0 ? 'down' : 'up');
                    }
                }
            });
        }
        
        function handleDirectionInput(direction) {
            if (gameState.isGameOver || gameState.isPaused) return;
            
            let newDirection = null;
            const currentDir = gameState.direction;
            
            switch (direction) {
                case 'up':
                    if (currentDir.y === 0) {
                        newDirection = { x: 0, y: -1 };
                    }
                    break;
                case 'down':
                    if (currentDir.y === 0) {
                        newDirection = { x: 0, y: 1 };
                    }
                    break;
                case 'left':
                    if (currentDir.x === 0) {
                        newDirection = { x: -1, y: 0 };
                    }
                    break;
                case 'right':
                    if (currentDir.x === 0) {
                        newDirection = { x: 1, y: 0 };
                    }
                    break;
            }
            
            if (newDirection) {
                gameState.nextDirection = newDirection;
                
                // Visual feedback
                const head = gameState.snake[0];
                const particleX = head.x * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2;
                const particleY = head.y * GAME_CONFIG.gridSize + GAME_CONFIG.gridSize / 2;
                createDirectionChangeEffect(particleX, particleY, newDirection);
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.querySelector('.loading');
            
            try {
                await initializeGameAssets();
                
                // Initialize touch controls
                initializeTouchControls();
                
                // Handle window resize
                function handleResize() {
                    const gameWrapper = document.querySelector('.game-wrapper');
                    if (!gameWrapper) return;
                    
                    const size = Math.min(
                        gameWrapper.offsetWidth,
                        gameWrapper.offsetHeight
                    );
                    
                    canvas.style.width = size + 'px';
                    canvas.style.height = size + 'px';
                }
                
                window.addEventListener('resize', handleResize);
                handleResize();
                
                // Fade out loading screen
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    navigateTo('main-menu');
                    initializePaymentSystem();
                }, 300);
                
            } catch (error) {
                console.error('Error loading game assets:', error);
                loadingScreen.querySelector('.loading-title').textContent = 'Error loading game...';
            }
        });
    </script>
</body>
</html>
