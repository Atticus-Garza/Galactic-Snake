<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Snake</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Styling */
        :root {
            --background-color: #111827;
            --primary-color: #4CAF50;
            --accent-color: #3B82F6;
            --text-color: #E5E7EB;
            --border-color: #4B5563;
            --game-over-color: #EF4444;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            color: var(--text-color);
            text-align: center;
        }

        .page-container {
            width: 90%;
            max-width: 600px;
            background: #1F2937;
            border: 3px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 0 20px var(--accent-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1 {
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
            margin-top: 0;
        }

        /* Canvas and Game Elements */
        #gameCanvas {
            background-color: #111827;
            border: 2px solid var(--border-color);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .game-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .score-panel, .level-panel {
            font-size: 1.2em;
            font-weight: 700;
        }

        #score, #level {
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
        }

        /* Control Buttons */
        button {
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 0 10px var(--accent-color);
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: #5B9BF8;
            box-shadow: 0 0 15px var(--accent-color);
        }

        .button-group button {
            margin: 5px;
        }

        /* Modal for Game Over */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1F2937;
            padding: 30px;
            border: 3px solid var(--border-color);
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 20px var(--game-over-color);
        }

        .modal-content h2 {
            color: var(--game-over-color);
            text-shadow: 0 0 10px var(--game-over-color);
        }

        /* High Score Table */
        #highScoresContainer {
            margin-top: 20px;
            background: #1F2937;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }

        #highScoresContainer h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        #highScoresTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #highScoresTable th, #highScoresTable td {
            padding: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #highScoresTable th {
            background-color: #3B82F6;
            color: white;
        }

        #highScoresTable tr:nth-child(even) {
            background-color: #2D3748;
        }

        /* Hide pages by default */
        .page {
            display: none;
        }
        .page.active {
            display: flex;
        }
        
        /* Main Menu Styling */
        #main-menu .button-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            .score-panel p, .level-panel p {
                font-size: 1em;
            }
            button {
                font-size: 0.9em;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>


    <div id="main-menu" class="page active">
        <div class="page-container">
            <h1>Galactic Snake</h1>
            <div class="button-group">
                <button id="playGameButton">Play Game</button>
                <button id="viewHighScoresButton">High Scores</button>
                <button id="openStoreButton">Subscription Store</button>
            </div>
        </div>
    </div>

    <!-- Subscription Store Page -->
    <div id="store-page" class="page">
        <div class="page-container">
            <h1>Subscription Store</h1>
            <div class="subscription-options">
                <div class="subscription-card">
                    <h2>Premium</h2>
                    <p>Unlock all premium features!</p>
                    <p><strong>$4.99/month</strong></p>
                    <button class="pay-cashapp" data-plan="premium">Pay with CashApp</button>
                    <button class="pay-paypal" data-plan="premium">Pay with PayPal</button>
                </div>
                <div class="subscription-card">
                    <h2>Ultimate</h2>
                    <p>All premium + exclusive skins!</p>
                    <p><strong>$9.99/month</strong></p>
                    <button class="pay-cashapp" data-plan="ultimate">Pay with CashApp</button>
                    <button class="pay-paypal" data-plan="ultimate">Pay with PayPal</button>
                </div>
            </div>
            <div class="skins-section" style="margin-top:40px;">
                <h2>Choose Your Snake Skin</h2>
                <div style="margin-bottom:10px;font-size:1.1em;color:gold;">
                    <span id="currencyDisplay">Stars: 0</span>
                </div>
                <div id="skinsContainer" style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">
                    <button class="skin-btn" data-skin="üêç">Classic (Free)</button>
                    <button class="skin-btn" data-skin="ü¶é" data-price="5">Lizard (5‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶î" data-price="10">Hedgehog (10‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶ö" data-price="15">Peacock (15‚≠ê)</button>
                    <button class="skin-btn" data-skin="üêâ" data-price="20">Dragon (20‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶ï" data-price="25">Dino (25‚≠ê)</button>
                    <button class="skin-btn" data-skin="ü¶ñ" data-price="30">T-Rex (30‚≠ê)</button>
                    <button class="skin-btn" data-skin="üßë‚ÄçüöÄ" data-price="40">Astronaut (40‚≠ê)</button>
                </div>
            <div class="buy-stars-section" style="margin-top:30px;">
                <h2>Buy More Stars</h2>
                <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                    <div style="background:#232946;border:2px solid gold;border-radius:12px;padding:15px;min-width:160px;display:flex;flex-direction:column;align-items:center;">
                        <span style="font-size:1.3em;color:gold;">50‚≠ê</span>
                        <span style="margin:8px 0;">$1.99</span>
                        <button class="buy-stars-btn" data-amount="50" data-price="1.99" data-method="cashapp">Buy with CashApp</button>
                        <button class="buy-stars-btn" data-amount="50" data-price="1.99" data-method="paypal">Buy with PayPal</button>
                    </div>
                    <div style="background:#232946;border:2px solid gold;border-radius:12px;padding:15px;min-width:160px;display:flex;flex-direction:column;align-items:center;">
                        <span style="font-size:1.3em;color:gold;">150‚≠ê</span>
                        <span style="margin:8px 0;">$4.99</span>
                        <button class="buy-stars-btn" data-amount="150" data-price="4.99" data-method="cashapp">Buy with CashApp</button>
                        <button class="buy-stars-btn" data-amount="150" data-price="4.99" data-method="paypal">Buy with PayPal</button>
                    </div>
                    <div style="background:#232946;border:2px solid gold;border-radius:12px;padding:15px;min-width:160px;display:flex;flex-direction:column;align-items:center;">
                        <span style="font-size:1.3em;color:gold;">500‚≠ê</span>
                        <span style="margin:8px 0;">$14.99</span>
                        <button class="buy-stars-btn" data-amount="500" data-price="14.99" data-method="cashapp">Buy with CashApp</button>
                        <button class="buy-stars-btn" data-amount="500" data-price="14.99" data-method="paypal">Buy with PayPal</button>
                    </div>
                </div>
                <p id="buyStarsStatus" style="margin-top:10px;color:var(--accent-color);"></p>
            </div>

            <!-- Buy/Subscription Confirmation Modal -->
            <div id="confirmOrderModal" class="modal">
                <div class="modal-content" style="box-shadow: 0 0 20px gold;">
                    <h2 style="color:gold;">Confirm Your Purchase</h2>
                    <p id="confirmOrderText"></p>
                    <div id="cashappInstructions" style="display:none;color:#FFD700;margin-bottom:10px;">
                        <strong>CashApp:</strong> Please complete your payment in CashApp and get your web receipt. Enter the code below to confirm your order.
                    </div>
                    <div style="margin:10px 0;">
                        <label for="orderCodeInput">Enter Order Code:</label>
                        <input type="text" id="orderCodeInput" maxlength="12" style="margin-left:8px;">
                    </div>
                    <button id="confirmOrderButton">Confirm Order</button>
                    <button id="cancelOrderButton">Cancel</button>
                    <p id="orderCodeStatus" style="margin-top:10px;color:var(--accent-color);"></p>
                </div>
            </div>
            </div>
                <p id="skinStatus" style="margin-top:10px;color:var(--accent-color);"></p>
            </div>
            <div class="button-group">
                <button id="backToMenuFromStore">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div id="processingModal" class="modal">
        <div class="modal-content" style="box-shadow: 0 0 20px var(--accent-color);">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <div class="spinner" style="margin-bottom: 20px;">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                        <circle cx="24" cy="24" r="20" stroke="#3B82F6" stroke-width="6" opacity="0.2"/>
                        <path d="M44 24c0-11.046-8.954-20-20-20" stroke="#3B82F6" stroke-width="6" stroke-linecap="round">
                            <animateTransform attributeName="transform" type="rotate" from="0 24 24" to="360 24 24" dur="1s" repeatCount="indefinite"/>
                        </path>
                    </svg>
                </div>
                <h2 style="color: var(--accent-color);">Processing...</h2>
            </div>
        </div>
    </div>

    <div id="game-page" class="page">
        <div class="page-container">
            <h1>Galactic Snake</h1>
            <canvas id="gameCanvas"></canvas>
            <div class="game-info">
                <div class="score-panel">
                    <p>Score: <span id="score">0</span></p>
                </div>
                <div class="level-panel">
                    <p>Level: <span id="level">1</span></p>
                </div>
                <div class="controls-panel">
                    <button id="backToMenuButton">Back to Menu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="high-scores-page" class="page">
        <div class="page-container">
            <h1>High Scores</h1>
            <div id="highScoresContainer">
                <h3>Leaderboard</h3>
                <table id="highScoresTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- High scores will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="button-group">
                <button id="backToMenuFromHighScores">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2>Game Over</h2>
            <p id="finalScore"></p>
            <p>Enter your name for the leaderboard:</p>
            <input type="text" id="playerName" maxlength="10" placeholder="Your Name">
            <button id="submitScoreButton">Submit Score</button>
            <button id="restartButton">Restart</button>
        </div>
    </div>

    <style>
        .subscription-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        .subscription-card {
            background: #232946;
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 20px;
            width: 220px;
            box-shadow: 0 0 10px var(--accent-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .subscription-card h2 {
            color: var(--primary-color);
        }
        .subscription-card button {
            margin: 8px 0;
        }
    </style>
    <script>
    // --- DOM Elements ---
    const openStoreButton = document.getElementById('openStoreButton');
    const storePage = document.getElementById('store-page');
    const backToMenuFromStore = document.getElementById('backToMenuFromStore');
    const backToGameFromStore = document.getElementById('backToGameFromStore');
    const processingModal = document.getElementById('processingModal');
    const skinsContainer = document.getElementById('skinsContainer');
    const skinStatus = document.getElementById('skinStatus');
    const currencyDisplay = document.getElementById('currencyDisplay');
        // --- Processing Modal Functions ---
        function showProcessing() {
            processingModal.style.display = 'flex';
        }
        function hideProcessing() {
            processingModal.style.display = 'none';
        }
        const mainMenu = document.getElementById('main-menu');
        const gamePage = document.getElementById('game-page');
        const highScoresPage = document.getElementById('high-scores-page');
        const playGameButton = document.getElementById('playGameButton');
        const viewHighScoresButton = document.getElementById('viewHighScoresButton');
        const backToMenuButton = document.getElementById('backToMenuButton');
        const backToMenuFromHighScores = document.getElementById('backToMenuFromHighScores');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const restartButton = document.getElementById('restartButton');
        const submitScoreButton = document.getElementById('submitScoreButton');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreElement = document.getElementById('finalScore');
        const playerNameInput = document.getElementById('playerName');
        const highScoresTableBody = document.querySelector('#highScoresTable tbody');

        // --- Game Constants and State ---
        const gridSize = 20;
        const canvasSize = 400;
        canvas.width = canvasSize;
        canvas.height = canvasSize;

        let snake, food, score, level, direction, gameInterval, gameSpeed;

        const spaceEmojis = ['ü™ê', '‚ú®', 'üõ∏', 'üöÄ', 'üåå', 'üå†'];
        // --- Skins ---
        const SKIN_KEY = 'galacticSnakeSkin';
        // --- Skins and Currency ---
        const skinAccess = {
            'üêç': true, // Classic
            'ü¶é': false, // Lizard
            'ü¶î': false, // Hedgehog
            'ü¶ö': false, // Peacock
            'üêâ': false, // Dragon
            'ü¶ï': false, // Dino
            'ü¶ñ': false, // T-Rex
            'üßë‚ÄçüöÄ': false // Astronaut
        };
    const buyStarsStatus = document.getElementById('buyStarsStatus');
    const confirmStarsModal = document.getElementById('confirmStarsModal');
    const confirmStarsText = document.getElementById('confirmStarsText');
    const orderCodeInput = document.getElementById('orderCodeInput');
    const confirmOrderButton = document.getElementById('confirmOrderButton');
    const cancelOrderButton = document.getElementById('cancelOrderButton');
    const orderCodeStatus = document.getElementById('orderCodeStatus');
    const cashappInstructions = document.getElementById('cashappInstructions');
        const skinTailColors = {
            'üêç': '#4CAF50',
            'ü¶é': '#8BC34A',
            'ü¶î': '#795548',
            'ü¶ö': '#2196F3',
            'üêâ': '#E91E63',
            'ü¶ï': '#FFEB3B',
            'ü¶ñ': '#FF9800',
            'üßë‚ÄçüöÄ': '#B0BEC5'
        };
        const CURRENCY_KEY = 'galacticSnakeStars';
        let stars = parseInt(localStorage.getItem(CURRENCY_KEY) || '50'); // Start with 50 for demo
        let snakeHeadEmoji = localStorage.getItem(SKIN_KEY) || 'üêç';
        const initialGameSpeed = 150;
        const speedIncreasePerLevel = 10;
        const HIGH_SCORES_KEY = 'galacticSnakeHighScores';

    // --- Page Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function navigateTo(pageId) {
            showPage(pageId);
            // Stop the game if we navigate away from the game page
            if (pageId !== 'game-page') {
                clearInterval(gameInterval);
            }
            if (pageId === 'high-scores-page') {
                displayHighScores();
            }
        }

        // --- High Score Functions ---
        function getHighScores() {
            const highScores = JSON.parse(localStorage.getItem(HIGH_SCORES_KEY) || '[]');
            return highScores.sort((a, b) => b.score - a.score).slice(0, 10);
        }

        function saveHighScores(scoreEntry) {
            const highScores = getHighScores();
            highScores.push(scoreEntry);
            const sortedScores = highScores.sort((a, b) => b.score - a.score).slice(0, 10);
            localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(sortedScores));
        }

        function displayHighScores() {
            const highScores = getHighScores();
            highScoresTableBody.innerHTML = '';

            highScores.forEach((entry, index) => {
                const row = highScoresTableBody.insertRow();
                const rankCell = row.insertCell();
                const nameCell = row.insertCell();
                const scoreCell = row.insertCell();

                rankCell.textContent = index + 1;
                nameCell.textContent = entry.name;
                scoreCell.textContent = entry.score;
            });
        }

        // --- Game Functions ---
        function initGame() {
            snake = [{ x: 10, y: 10 }];
            food = {};
            score = 0;
            level = 1;
            gameSpeed = initialGameSpeed;
            direction = { x: 1, y: 0 };
            gameOverModal.style.display = 'none';
            scoreElement.textContent = score;
            levelElement.textContent = level;
            playerNameInput.value = '';
            generateFood();
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, gameSpeed);
        }

        function generateFood() {
            let newFoodPosition;
            do {
                newFoodPosition = {
                    x: Math.floor(Math.random() * (canvasSize / gridSize)),
                    y: Math.floor(Math.random() * (canvasSize / gridSize)),
                    emoji: spaceEmojis[Math.floor(Math.random() * spaceEmojis.length)]
                };
            } while (isSnakeCollision(newFoodPosition));
            food = newFoodPosition;
        }

        function isSnakeCollision(position) {
            return snake.some(segment => segment.x === position.x && segment.y === position.y);
        }

        function gameLoop() {
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (
                head.x < 0 || head.x >= canvasSize / gridSize ||
                head.y < 0 || head.y >= canvasSize / gridSize ||
                isSnakeCollision(head)
            ) {
                endGame();
                return;
            }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreElement.textContent = score;
                // Award 1 Star for eating food
                stars++;
                updateCurrencyDisplay();
                if (score % 5 === 0) {
                    level++;
                    levelElement.textContent = level;
                    // Award 5 Stars for leveling up
                    stars += 5;
                    updateCurrencyDisplay();
                    gameSpeed -= speedIncreasePerLevel;
                    if (gameSpeed < 50) gameSpeed = 50;
                    clearInterval(gameInterval);
                    gameInterval = setInterval(gameLoop, gameSpeed);
                }
                // Bonus: Award 10 Stars for every 25 points
                if (score > 0 && score % 25 === 0) {
                    stars += 10;
                    updateCurrencyDisplay();
                }
                generateFood();
            } else {
                snake.pop();
            }

            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvasSize, canvasSize);

            // Draw snake
            snake.forEach((segment, index) => {
                if (index === 0) {
                    ctx.font = `${gridSize}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'var(--primary-color)';
                    ctx.shadowBlur = 10;
                    ctx.fillText(snakeHeadEmoji, segment.x * gridSize + gridSize / 2, segment.y * gridSize + gridSize / 2);
                    ctx.shadowBlur = 0;
                } else {
                    ctx.fillStyle = skinTailColors[snakeHeadEmoji] || 'var(--primary-color)';
                    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize, gridSize);
                }
            });

            // Draw food as an emoji
            ctx.font = `${gridSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'var(--accent-color)';
            ctx.shadowBlur = 10;
            ctx.fillText(food.emoji, food.x * gridSize + gridSize / 2, food.y * gridSize + gridSize / 2);
            ctx.shadowBlur = 0;
        }
    // --- Skins Selection Logic ---
    function updateSkinAccess() {
        // Only Classic is always accessible
        skinAccess['üêç'] = true;
        Object.keys(skinAccess).forEach(skin => {
            if (localStorage.getItem('skinPurchased_' + skin) === 'true') {
                skinAccess[skin] = true;
            }
        });
    }
    // --- Buy Stars Logic ---
    // --- Buy Stars Confirmation Logic ---
    let pendingOrder = null;
    // Obfuscated reusable codes (base64 encoded)
    const REUSABLE_CODES = {
        premium: atob('UFJFTUlVTTExMw=='),
        ultimate: atob('VUxUUkE5OTk='),   
        stars1: atob('U1RBUlMwNTA='),   // 50 stars
        stars2: atob('U1RBUlMxNTA='),  // 150 stars
        stars3: atob('U1RBUlM1MDA=')   // 500 stars
    };
    function showConfirmOrderModal(type, amount, method, price) {
        let code = '';
        let text = '';
        if (type === 'stars') {
        code = amount === 50 ? REUSABLE_CODES.stars1 : amount === 150 ? REUSABLE_CODES.stars2 : amount === 500 ? REUSABLE_CODES.stars3 : '';
            text = `Order: ${amount} Stars for $${price} via ${method === 'cashapp' ? 'CashApp' : 'PayPal'}\nReusable code: ${code}`;
        } else if (type === 'premium') {
            code = REUSABLE_CODES.premium;
            text = `Order: Premium Subscription for $${price}/month via ${method === 'cashapp' ? 'CashApp' : 'PayPal'}\nReusable code: ${code}`;
        } else if (type === 'ultimate') {
            code = REUSABLE_CODES.ultimate;
            text = `Order: Ultimate Subscription for $${price}/month via ${method === 'cashapp' ? 'CashApp' : 'PayPal'}\nReusable code: ${code}`;
        }
        pendingOrder = {
            type,
            amount,
            method,
            price,
            code
        };
        confirmOrderText.textContent = text;
        orderCodeInput.value = '';
        orderCodeStatus.textContent = '';
        cashappInstructions.style.display = method === 'cashapp' ? 'block' : 'none';
        confirmOrderModal.style.display = 'flex';
        setTimeout(() => {
            window.open(method === 'cashapp' ? 'https://cash.app/' : 'https://www.paypal.com/', '_blank');
        }, 500);
    }
    function hideConfirmOrderModal() {
        confirmOrderModal.style.display = 'none';
        pendingOrder = null;
    }
    confirmOrderButton.addEventListener('click', () => {
        if (!pendingOrder) return;
        let entered = orderCodeInput.value.trim().toUpperCase();
        let validCode = false;
        if (pendingOrder.type === 'stars') {
            validCode = (pendingOrder.amount === 50 && entered === REUSABLE_CODES.stars1)
                || (pendingOrder.amount === 150 && entered === REUSABLE_CODES.stars2)
                || (pendingOrder.amount === 500 && entered === REUSABLE_CODES.stars3);
            if (validCode) {
                stars += pendingOrder.amount;
                updateCurrencyDisplay();
                buyStarsStatus.textContent = `Order confirmed! ${pendingOrder.amount} Stars added.`;
                hideConfirmOrderModal();
            } else {
                let expectedCode = pendingOrder.code;
                orderCodeStatus.textContent = `Incorrect code. Please enter the reusable code: ${expectedCode}`;
            }
        } else if (pendingOrder.type === 'premium' || pendingOrder.type === 'ultimate') {
            validCode = entered === pendingOrder.code;
            if (validCode) {
                buyStarsStatus.textContent = `Order confirmed! ${pendingOrder.type.charAt(0).toUpperCase() + pendingOrder.type.slice(1)} subscription activated.`;
                hideConfirmOrderModal();
            } else {
                let expectedCode = pendingOrder.code;
                orderCodeStatus.textContent = `Incorrect code. Please enter the reusable code: ${expectedCode}`;
            }
        }
    });
    cancelOrderButton.addEventListener('click', () => {
        hideConfirmOrderModal();
        buyStarsStatus.textContent = 'Order cancelled.';
    });

    function updateCurrencyDisplay() {
        if (currencyDisplay) currencyDisplay.textContent = `Stars: ${stars}`;
        localStorage.setItem(CURRENCY_KEY, stars);
    }

    function selectSkin(skin) {
        updateSkinAccess();
        if (skinAccess[skin]) {
            snakeHeadEmoji = skin;
            localStorage.setItem(SKIN_KEY, skin);
            skinStatus.textContent = `Skin changed to ${skin}!`;
        } else {
            // Try to buy if price exists
            const btn = skinsContainer.querySelector(`[data-skin='${skin}']`);
            const price = parseInt(btn.getAttribute('data-price') || '0');
            if (price > 0) {
                if (stars >= price) {
                    stars -= price;
                    skinAccess[skin] = true;
                    localStorage.setItem('skinPurchased_' + skin, 'true');
                    updateCurrencyDisplay();
                    snakeHeadEmoji = skin;
                    localStorage.setItem(SKIN_KEY, skin);
                    skinStatus.textContent = `Purchased and equipped ${skin}!`;
                } else {
                    skinStatus.textContent = `Not enough Stars to buy this skin!`;
                }
            } else {
                skinStatus.textContent = `This skin is locked!`;
            }
        }
    }

    if (skinsContainer) {
        updateSkinAccess();
        updateCurrencyDisplay();
        skinsContainer.querySelectorAll('.skin-btn').forEach(btn => {
            const skin = btn.getAttribute('data-skin');
            // Show owned/unowned status
            if (skinAccess[skin]) {
                btn.textContent += ' (Owned)';
                btn.disabled = false;
                btn.style.opacity = '1';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
            btn.addEventListener('click', function() {
                selectSkin(skin);
                // Update button labels after purchase
                updateSkinAccess();
                skinsContainer.querySelectorAll('.skin-btn').forEach(b => {
                    const s = b.getAttribute('data-skin');
                    if (skinAccess[s]) {
                        b.textContent = b.textContent.replace(/ ?\(Owned\)?$/, '') + ' (Owned)';
                    } else {
                        b.textContent = b.textContent.replace(/ ?\(Owned\)?$/, '');
                    }
                });
            });
        });
    }

    // Buy Stars event listeners
    document.querySelectorAll('.buy-stars-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const amount = parseInt(btn.getAttribute('data-amount'));
            const price = btn.getAttribute('data-price');
            const method = btn.getAttribute('data-method');
            showConfirmOrderModal('stars', amount, method, price);
        });
    });

        function endGame() {
            clearInterval(gameInterval);
            finalScoreElement.textContent = `Your final score is: ${score}`;
            gameOverModal.style.display = 'flex';
        }

        function handleSubmitScore() {
            const playerName = playerNameInput.value.trim();
            if (playerName) {
                saveHighScores({ name: playerName, score: score });
            }
            gameOverModal.style.display = 'none';
            navigateTo('main-menu');
        }

        function handleKeyPress(e) {
            const key = e.key;
            const currentDir = direction;

            switch (key) {
                case 'ArrowUp':
                case 'w':
                    if (currentDir.y === 0) direction = { x: 0, y: -1 };
                    break;
                case 'ArrowDown':
                case 's':
                    if (currentDir.y === 0) direction = { x: 0, y: 1 };
                    break;
                case 'ArrowLeft':
                case 'a':
                    if (currentDir.x === 0) direction = { x: -1, y: 0 };
                    break;
                case 'ArrowRight':
                case 'd':
                    if (currentDir.x === 0) direction = { x: 1, y: 0 };
                    break;
            }
        }
        
        // --- Event Listeners ---
        document.addEventListener('keydown', handleKeyPress);
        playGameButton.addEventListener('click', () => {
            initGame();
            navigateTo('game-page');
        });
        viewHighScoresButton.addEventListener('click', () => {
            navigateTo('high-scores-page');
        });
        backToMenuButton.addEventListener('click', () => {
            navigateTo('main-menu');
        });
        backToMenuFromHighScores.addEventListener('click', () => {
            navigateTo('main-menu');
        });
        restartButton.addEventListener('click', initGame);
        submitScoreButton.addEventListener('click', handleSubmitScore);
        openStoreButton.addEventListener('click', () => {
            navigateTo('store-page');
        });
        backToMenuFromStore.addEventListener('click', () => {
            navigateTo('main-menu');
        });
        backToGameFromStore.addEventListener('click', () => {
            navigateTo('game-page');
        });

        // Payment flow (mock)
        document.querySelectorAll('.pay-cashapp').forEach(btn => {
            btn.addEventListener('click', function() {
                const plan = btn.getAttribute('data-plan');
                let price = plan === 'premium' ? '4.99' : plan === 'ultimate' ? '9.99' : '';
                showConfirmOrderModal(plan, null, 'cashapp', price);
            });
        });
        document.querySelectorAll('.pay-paypal').forEach(btn => {
            btn.addEventListener('click', function() {
                const plan = btn.getAttribute('data-plan');
                let price = plan === 'premium' ? '4.99' : plan === 'ultimate' ? '9.99' : '';
                showConfirmOrderModal(plan, null, 'paypal', price);
            });
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            navigateTo('main-menu');
        });
    </script>
</body>
</html>
